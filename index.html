<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>หน่วยรับริจาควัดไชยามาตย์</title>
    <!-- โหลด Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Niramit&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Tahoma', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        body { font-family: "Niramit", sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .data-table th, .data-table td { padding: 12px 16px; text-align: left; border-bottom: 1px solid #e5e7eb; }
        .disabled-option { color: #9ca3af; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex">

    <div id="app-container" class="flex flex-col w-full h-screen overflow-hidden">
        
        <!-- Navbar (Top Bar) -->
        <header class="bg-white shadow-md p-4 flex justify-between items-center z-10">
            <div class="text-xl font-bold text-indigo-600 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 mr-2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a2.25 2.25 0 0 0-2.25-2.25H15a1.5 1.5 0 0 1-1.5-1.5V5.25A2.25 2.25 0 0 0 12.75 3h-5.25A2.25 2.25 0 0 0 5.25 5.25v13.5C5.25 20.21 6.81 21.75 8.716 21.75h9.034C20.197 21.75 21 20.945 21 19.988V12Zm-13.5 0h3.375" />
                </svg>
                ระบบบันทึกรายนามผู้บริจาค หน่วยรับบริจาควัดไชยามาตย์
            </div>
            <div id="auth-info" class="text-sm text-gray-700">
                <span id="user-status" class="font-medium text-gray-500">กำลังเชื่อมต่อฐานข้อมูล...</span>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="flex flex-1 overflow-hidden">
            
            <!-- Sidebar Navigation -->
            <nav id="sidebar" class="w-64 bg-gray-800 text-white flex flex-col p-4 space-y-2 transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out z-20">
                <div class="text-lg font-semibold mb-4 border-b border-gray-700 pb-2">เมนูหลัก</div>
                
                <a href="#report" data-page="report" class="sidebar-link flex items-center p-3 rounded-lg hover:bg-indigo-700 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-3">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 5.465 11.25 1.09 12.75 3.515M21 13.125c0 7.66-8.25 12.035-9.75 9.61m7.5-6c.664.184 1.293.307 1.884.34m1.163-.099c1.085-.295 1.83-1.253 1.83-2.352V7.125c0-1.1-.745-2.057-1.83-2.352c-.198-.053-.399-.101-.601-.148M16.5 18H5.625c-1.033 0-1.99.645-2.333 1.624C3.078 20.472 4.14 21 5.25 21h13.5c1.11 0 2.172-.528 2.563-1.376c-.44-.092-.898-.186-1.36-.277M19.5 7.5a1.5 1.5 0 1 0 0-3a1.5 1.5 0 0 0 0 3ZM12.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Z" />
                    </svg>                      
                    สรุปรายงานการบริจาค
                </a>
                
                <a href="#form" data-page="form" class="sidebar-link flex items-center p-3 rounded-lg hover:bg-indigo-700 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-3">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m5.25 9c.354 0 .692.054 1.01.144M19.5 14.25a2.25 2.25 0 0 0 1.5-2.126V5.25L16.25 2.25H5.25A2.25 2.25 0 0 0 3 4.5v15c0 1.243.834 2.25 1.875 2.25H16.5M16.5 14.25H12a3.75 3.75 0 0 1-3.75-3.75V8.25m0 0h3.375a3.75 3.75 0 0 0 3.75-3.75V4.5m-3.75 10.5h3.375" />
                    </svg>
                    ลงทะเบียนบริจาคใหม่
                </a>
            </nav>

            <!-- Page Content -->
            <div id="content-area" class="flex-1 p-6 md:p-10 overflow-y-auto no-scrollbar transition-all duration-300">
                <div id="page-content" class="max-w-7xl mx-auto">
                    <!-- Loading State -->
                    <div id="loading-spinner" class="text-center p-10">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 inline-block"></div>
                        <p class="mt-4 text-gray-600">กำลังโหลดระบบและเชื่อมต่อฐานข้อมูล...</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Firebase SDKs and Client-side Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        setLogLevel('Debug');

        // --- Firebase Configuration (Hardcoded with user's values) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDNaO2HHArhTOVVxNkuOxJo5Mi7rnLjJm4",
            authDomain: "donation-tracking-app-dd170.firebaseapp.com",
            projectId: "donation-tracking-app-dd170",
            storageBucket: "donation-tracking-app-dd170.firebasestorage.app",
            messagingSenderId: "833004688501",
            appId: "1:833004688501:web:29018b275a63a88f64143c",
            measurementId: "G-STR611C62Q"
        };

        // สำหรับกำหนด Collection Path 
        // เมื่อใช้โปรเจกต์ Firebase ของตัวเอง จะใช้ Collection Path ที่เรียบง่าย
        const appId = firebaseConfig.projectId; // ใช้ Project ID เป็นตัวระบุแอปฯ
        let PUBLIC_DONATION_COLLECTION_PATH = 'donations'; // ชื่อ Collection สำหรับเก็บข้อมูล

        let app, db, auth;
        let userId = null;
        let donations = [];
        let isAuthReady = false;
        
        // ID อัตโนมัติ (Timestamp based)
        const generateDonationId = () => Date.now().toString(36) + Math.random().toString(36).substring(2, 5);

        // --- DOM Elements ---
        const pageContent = document.getElementById('page-content');
        const loadingSpinner = document.getElementById('loading-spinner');
        const userStatus = document.getElementById('user-status');
        const sidebarLinks = document.querySelectorAll('.sidebar-link');

        // --- Firebase Initialization and Authentication ---

        async function initializeFirebase() {
            try {
                if (!firebaseConfig.apiKey) {
                    throw new Error("Firebase API Key is missing. Check your configuration.");
                }

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // 1. ตรวจสอบสถานะการเข้าสู่ระบบ
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userStatus.textContent = `ผู้ใช้: ${userId} (เชื่อมต่อแล้ว)`;
                        isAuthReady = true;
                        setupRealtimeDonationsListener();
                    } else {
                        // 2. ถ้ายังไม่เข้าสู่ระบบ ให้เข้าสู่ระบบแบบไม่ระบุตัวตน (Anonymous) ทันที
                        try {
                            await signInAnonymously(auth);
                        } catch (error) {
                            console.error("Error signing in anonymously:", error);
                            userStatus.textContent = 'ไม่สามารถเข้าสู่ระบบได้ (โปรดตรวจสอบกฎความปลอดภัย)';
                            loadingSpinner.classList.add('hidden');
                        }
                    }
                });

            } catch (error) {
                console.error("Error initializing Firebase:", error);
                loadingSpinner.innerHTML = `<p class="text-red-600 font-semibold">ข้อผิดพลาด: ไม่สามารถเชื่อมต่อฐานข้อมูลได้ (${error.message})</p>`;
            }
        }

        // --- Firestore Operations ---
        
        function setupRealtimeDonationsListener() {
            // สร้าง reference ไปยัง collection 'donations'
            const donationsRef = collection(db, PUBLIC_DONATION_COLLECTION_PATH);
            
            // onSnapshot คือฟังก์ชันที่รอฟังการเปลี่ยนแปลงของข้อมูลแบบ Real-time
            onSnapshot(donationsRef, (snapshot) => {
                const newDonations = [];
                snapshot.forEach((doc) => {
                    newDonations.push({ id: doc.id, ...doc.data() });
                });
                // จัดเรียงตามวันที่บริจาคล่าสุดก่อน
                donations = newDonations.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                renderCurrentPage(); // เรนเดอร์หน้าใหม่ทุกครั้งที่ข้อมูลเปลี่ยน
            }, (error) => {
                console.error("Error listening to donations:", error);
                // แสดงข้อความเตือนถ้า Listener มีปัญหา (อาจเกิดจาก Security Rules)
                pageContent.innerHTML = `<div class="p-4 bg-yellow-100 text-yellow-800 rounded-lg">ไม่สามารถโหลดข้อมูลได้แบบ Real-time: ${error.message}. <br>โปรดตรวจสอบ **Firebase Firestore Security Rules** ของคุณ.</div>`;
            });
            loadingSpinner.classList.add('hidden');
        }

        async function saveDonation(donationData) {
            if (!isAuthReady) {
                return { success: false, message: "ระบบยังไม่พร้อมใช้งาน (Auth not ready)" };
            }
            
            try {
                const donationsRef = collection(db, PUBLIC_DONATION_COLLECTION_PATH);
                await addDoc(donationsRef, {
                    ...donationData,
                    id: generateDonationId(), // สร้าง ID อัตโนมัติ
                    amount: parseFloat(donationData.amount || 0), 
                    timestamp: new Date().toISOString(),
                    donatedByUserId: userId 
                });
                return { success: true, message: "ลงทะเบียนการบริจาคสำเร็จ! (บันทึกใน Firestore)" };
            } catch (error) {
                console.error("Error saving donation:", error);
                return { success: false, message: `เกิดข้อผิดพลาดในการบันทึกข้อมูล: ${error.message}` };
            }
        }

        // --- UI & Routing Logic (โค้ดส่วนนี้ยังคงเดิม) ---
        
        function displayMessage(element, message, type) {
            element.classList.remove('hidden', 'bg-green-100', 'text-green-700', 'bg-red-100', 'text-red-700');
            element.classList.add(type === 'success' ? 'bg-green-100' : 'bg-red-100', type === 'success' ? 'text-green-700' : 'text-red-700');
            element.textContent = message;
            setTimeout(() => { element.classList.add('hidden'); }, 5000);
        }

        function renderFormPage() {
            pageContent.innerHTML = `
                <h1 class="text-3xl font-extrabold text-gray-900 mb-8">ลงทะเบียนการบริจาค</h1>
                <div id="form-message" class="mb-4 hidden p-3 rounded-lg"></div>

                <form id="donation-form" class="space-y-6 p-6 bg-white rounded-xl shadow-lg border border-gray-100">
                    
                    <!-- ส่วนที่ 1: ข้อมูลผู้บริจาค -->
                    <h2 class="text-xl font-semibold text-indigo-700 border-b pb-2 mb-4">1. ข้อมูลผู้บริจาค</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        
                        <!-- ประเภทผู้บริจาค -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ประเภทผู้บริจาค *</label>
                            <select id="donorType" name="donorType" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border bg-white focus:border-indigo-500 focus:ring-indigo-500">
                                <option value="individual">บุคคลธรรมดา</option>
                                <option value="corporate">นิติบุคคล/องค์กร</option>
                            </select>
                        </div>

                        <!-- ชื่อ - สกุล / ชื่อองค์กร -->
                        <div id="name-field">
                            <label for="fullName" class="block text-sm font-medium text-gray-700">ชื่อ - นามสกุล *</label>
                            <input type="text" id="fullName" name="fullName" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border focus:border-indigo-500 focus:ring-indigo-500">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- เลขประจำตัวประชาชน/ผู้เสียภาษี -->
                        <div>
                            <label for="taxId" class="block text-sm font-medium text-gray-700">เลขประจำตัว (13 หลัก) </label>
                            <input type="text" id="taxId" name="taxId"  maxlength="13" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border focus:border-indigo-500 focus:ring-indigo-500">
                            <p class="mt-1 text-xs text-gray-500">สำหรับออกใบเสร็จลดหย่อนภาษี</p>
                        </div>
                        <!-- เบอร์โทรศัพท์ -->
                        <div>
                            <label for="phoneNumber" class="block text-sm font-medium text-gray-700">เบอร์โทรศัพท์ </label>
                            <input type="tel" id="phoneNumber" name="phoneNumber"  maxlength="10" pattern="[0-9]{10}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border focus:border-indigo-500 focus:ring-indigo-500">
                        </div>
                    </div>
                    
                    <!-- หมายเหตุ -->
                    <div>
                        <label for="remark" class="block text-sm font-medium text-gray-700">หมายเหตุ</label>
                        <textarea id="remark" name="remark" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border focus:border-indigo-500 focus:ring-indigo-500"></textarea>
                    </div>

                    <!-- ส่วนที่ 2: รายละเอียดการบริจาค -->
                    <h2 class="text-xl font-semibold text-indigo-700 border-b pt-4 pb-2 mb-4">2. รายละเอียดการบริจาค</h2>

                    <!-- ประเภทการบริจาค -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ประเภทการบริจาค *</label>
                        <div id="donation-type-group" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <label class="inline-flex items-center p-3 border rounded-lg bg-gray-50 hover:bg-indigo-50 cursor-pointer">
                                <input type="radio" name="donationType" value="เงินสด" class="form-radio text-indigo-600 h-4 w-4" checked>
                                <span class="ml-2 text-gray-700">เงินสด</span>
                            </label>
                            <label class="inline-flex items-center p-3 border rounded-lg bg-gray-50 hover:bg-indigo-50 cursor-pointer">
                                <input type="radio" name="donationType" value="โอนเงิน" class="form-radio text-indigo-600 h-4 w-4">
                                <span class="ml-2 text-gray-700">โอนเงิน</span>
                            </label>
                            <label class="inline-flex items-center p-3 border rounded-lg bg-gray-50 hover:bg-indigo-50 cursor-pointer">
                                <input type="radio" name="donationType" value="ทรัพย์สิน" class="form-radio text-indigo-600 h-4 w-4">
                                <span class="ml-2 text-gray-700">ทรัพย์สิน/สิ่งของ</span>
                            </label>
                            <label class="inline-flex items-center p-3 border rounded-lg bg-gray-50 hover:bg-indigo-50 cursor-pointer">
                                <input type="radio" name="donationType" value="โรงทาน" class="form-radio text-indigo-600 h-4 w-4">
                                <span class="ml-2 text-gray-700">โรงทาน</span>
                            </label>
                        </div>
                    </div>

                    <!-- จำนวนเงิน/มูลค่า -->
                    <div id="amount-group">
                        <label for="amount" class="block text-sm font-medium text-gray-700">จำนวนเงินบริจาค (บาท) / มูลค่าสิ่งของ *</label>
                        <input type="number" id="amount" name="amount" required min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border focus:border-indigo-500 focus:ring-indigo-500" placeholder="ระบุจำนวนเงิน">
                    </div>
                    
                    <!-- วัตถุประสงค์ -->
                    <div>
                        <label for="purpose" class="block text-sm font-medium text-gray-700">วัตถุประสงค์การบริจาค</label>
                        <select id="purpose" name="purpose" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border bg-white focus:border-indigo-500 focus:ring-indigo-500">
                            <option value="กฐินสามัคคี 2568">เพื่อสมทบกฐินสามัคคี 2568</option>
                            <option value="ทั่วไป">เพื่อการดำเนินงานทั่วไป</option>
                            <option value="งานนมัสการพระธาตุประจำปี 2569" disabled class="disabled-option">งานนมัสการพระธาตุประจำปี 2569 </option>
                        </select>
                    </div>

                    <!-- ส่วนที่ 3: เอกสารหลักฐาน -->
                    <h2 class="text-xl font-semibold text-indigo-700 border-b pt-4 pb-2 mb-4">3. เอกสารที่ต้องการเป็นหลักฐาน</h2>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">เอกสารหลักฐาน *</label>
                        <div class="flex space-x-6">
                            <label class="inline-flex items-center">
                                <input type="radio" name="taxReceipt" value="ต้องการรับ" class="form-radio text-indigo-600 h-4 w-4" >
                                <span class="ml-2 text-gray-700">ต้องการรับใบลดหย่อนภาษี</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="taxReceipt" value="ไม่ต้องการ" class="form-radio text-indigo-600 h-4 w-4" checked >
                                <span class="ml-2 text-gray-700">ไม่ต้องการรับใบลดหย่อนภาษี</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- ปุ่มส่งฟอร์ม -->
                    <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-base font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors duration-200">
                        <svg id="submit-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                        </svg>
                        <div id="submit-text">ยืนยันและบันทึกข้อมูลการบริจาค</div>
                    </button>
                </form>
            `;

            const form = document.getElementById('donation-form');
            const formMessage = document.getElementById('form-message');
            const donorTypeSelect = form.querySelector('#donorType');
            const nameFieldDiv = form.querySelector('#name-field');
            
            const updateFormUI = () => {
                const isCorporate = donorTypeSelect.value === 'corporate';
                
                let labelText = isCorporate ? 'ชื่อองค์กร *' : 'ชื่อ - นามสกุล *';
                let inputName = isCorporate ? 'corporateName' : 'fullName';
                
                nameFieldDiv.innerHTML = `
                    <label for="${inputName}" class="block text-sm font-medium text-gray-700">${labelText}</label>
                    <input type="text" id="${inputName}" name="${inputName}" required 
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border focus:border-indigo-500 focus:ring-indigo-500">
                `;
            };

            donorTypeSelect.addEventListener('change', updateFormUI);
            
            updateFormUI();

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const formData = new FormData(form);
                const data = {};
                for (const [key, value] of formData.entries()) {
                    if (key === 'corporateName' && formData.get('donorType') === 'corporate') {
                         data['fullName'] = value.trim();
                    } else if (key !== 'corporateName') {
                         data[key] = value.trim();
                    }
                }
                
                const submitButton = form.querySelector('button[type="submit"]');
                const submitText = document.getElementById('submit-text');
                const submitIconContainer = form.querySelector('#submit-icon').parentNode;

                submitButton.disabled = true;
                submitButton.classList.add('bg-gray-400', 'cursor-not-allowed');
                submitButton.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                
                const originalIconHtml = submitIconContainer.innerHTML;
                submitIconContainer.innerHTML = '<div id="submit-icon" class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mr-2"></div><div id="submit-text">กำลังบันทึกข้อมูล...</div>';

                const result = await saveDonation(data);

                if (result.success) {
                    displayMessage(formMessage, result.message, 'success');
                    form.reset(); 
                    updateFormUI(); 
                } else {
                    displayMessage(formMessage, result.message, 'error');
                }

                submitButton.disabled = false;
                submitButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
                submitButton.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                
                submitIconContainer.innerHTML = originalIconHtml;
                document.getElementById('submit-text').textContent = 'ยืนยันและบันทึกข้อมูลการบริจาค';
            });
        }

        function renderReportPage() {
            const totalDonations = donations.length;
            const totalAmount = donations
                .filter(d => (d.donationType === 'เงินสด' || d.donationType === 'โอนเงิน') && d.amount)
                .reduce((sum, d) => sum + d.amount, 0);
            
            const moneyDonationsCount = donations.filter(d => d.donationType === 'เงินสด' || d.donationType === 'โอนเงิน').length;
            const goodsDonationsCount = donations.filter(d => d.donationType === 'ทรัพย์สิน' || d.donationType === 'โรงทาน').length;

            pageContent.innerHTML = `
                <h1 class="text-3xl font-extrabold text-gray-900 mb-8">สรุปรายงานการบริจาค</h1>
                <div class="mb-6 p-3 bg-blue-100 border border-blue-400 text-blue-700 rounded-lg text-sm">
                    ✅ ข้อมูลในหน้านี้เป็น Real-time
                </div>

                <!-- Summary Cards -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
                    <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-indigo-500">
                        <div class="text-sm font-medium text-gray-500">รายการบริจาคทั้งหมด</div>
                        <div class="text-3xl font-bold text-gray-900 mt-1">${totalDonations.toLocaleString()}</div>
                        <div class="text-xs text-gray-400 mt-2">รวมเงินสดและสิ่งของ</div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-green-500">
                        <div class="text-sm font-medium text-gray-500">ยอดเงินบริจาครวม (บาท)</div>
                        <div class="text-3xl font-bold text-gray-900 mt-1">${totalAmount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
                        <div class="text-xs text-gray-400 mt-2">เฉพาะรายการบริจาคเงิน</div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-blue-500">
                        <div class="text-sm font-medium text-gray-500">จำนวนรายการเงินสด/โอน</div>
                        <div class="text-3xl font-bold text-gray-900 mt-1">${moneyDonationsCount.toLocaleString()}</div>
                        <div class="text-xs text-gray-400 mt-2">รายการเงินสดและโอนเงิน</div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-orange-500">
                        <div class="text-sm font-medium text-gray-500">จำนวนรายการสิ่งของ/โรงทาน</div>
                        <div class="text-3xl font-bold text-gray-900 mt-1">${goodsDonationsCount.toLocaleString()}</div>
                        <div class="text-xs text-gray-400 mt-2">รายการทรัพย์สิน/โรงทาน</div>
                    </div>
                </div>

                <!-- Data Table -->
                <div class="bg-white p-6 rounded-xl shadow-lg overflow-x-auto">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">ตารางรายการบริจาคทั้งหมด</h2>
                    <table class="min-w-full divide-y divide-gray-200 data-table">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="text-xs font-medium text-gray-500 uppercase tracking-wider">วันที่บริจาค</th>
                                <th scope="col" class="text-xs font-medium text-gray-500 uppercase tracking-wider">ผู้บริจาค</th>
                                <th scope="col" class="text-xs font-medium text-gray-500 uppercase tracking-wider">ประเภท</th>
                                <th scope="col" class="text-xs font-medium text-gray-500 uppercase tracking-wider">ยอดบริจาค (บาท)</th>
                                <th scope="col" class="text-xs font-medium text-gray-500 uppercase tracking-wider">หมายเหตุ</th>
                                <th scope="col" class="text-xs font-medium text-gray-500 uppercase tracking-wider">เอกสารใบลดหย่อน</th>
                                
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="donations-table-body">
                            ${donations.length === 0 
                                ? `<tr><td colspan="7" class="text-center py-4 text-gray-500">ยังไม่มีรายการบริจาคในระบบ</td></tr>`
                                : donations.map((d) => `
                                    <tr class="hover:bg-gray-50 transition-colors">
                                        <td>${new Date(d.timestamp).toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric' })}</td>
                                        <td>${d.fullName || '-'}</td>
                                        <td>
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${d.donationType.includes('เงิน') || d.donationType.includes('โอน') ? 'bg-green-100 text-green-800' : 'bg-orange-100 text-orange-800'}">
                                                ${d.donationType}
                                            </span>
                                        </td>
                                        <td>${d.amount.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 2 })}</td>
                                        <td>${d.remark || '-'}</td>
                                        <td>
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${d.taxReceipt.includes('ต้องการรับ')  ? 'bg-green-100 text-green-800' : 'bg-red-100 text-orange-800'}">
                                                ${d.taxReceipt || '-'}</td>
                                        
                                    </tr>
                                `).join('')
                            }
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderCurrentPage() {
            if (!isAuthReady && !loadingSpinner.classList.contains('hidden')) return;
            
            const hash = window.location.hash || '#report';
            
            sidebarLinks.forEach(link => {
                link.classList.remove('bg-indigo-600', 'font-bold');
            });

            const activeLink = document.querySelector(`.sidebar-link[data-page="${hash.substring(1)}"]`);
            if (activeLink) {
                activeLink.classList.add('bg-indigo-600', 'font-bold');
            }

            if (hash === '#form') {
                renderFormPage();
            } else {
                renderReportPage();
            }
        }

        window.addEventListener('hashchange', renderCurrentPage);
        
        sidebarLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                window.location.hash = link.getAttribute('data-page');
            });
        });

        initializeFirebase();
    </script>
</body>
</html>
